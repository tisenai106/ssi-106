datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

generator client {
  provider = "prisma-client-js"
}

// --- ENUMS ---

enum Role {
  COMMON
  TECHNICIAN
  MANAGER
  SUPER_ADMIN
}

enum Status {
  OPEN
  ASSIGNED
  IN_PROGRESS
  ON_HOLD // Ex: Aguardando peça
  RESOLVED
  CLOSED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AreaName {
  TI
  BUILDING
  ELECTRICAL
}

// --- MODELOS PRINCIPAIS ---

model User {
  id String @id @default(cuid()) // <-- CORREÇÃO: uuid() mudou para cuid()

  email        String       @unique
  name         String
  passwordHash String
  role         Role         @default(COMMON)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  areaId       String?
  photoUrl     String?
  // Relacionamentos
  area         Area?        @relation(fields: [areaId], references: [id])
  tickets      Ticket[]     @relation("TicketRequester") // Chamados que abriu
  assigned     Ticket[]     @relation("TicketTechnician") // Chamados para atender
  pushSubscriptions PushSubscription[]
  comments     Comment[]
  uploads      Attachment[]

  @@index([areaId])
  @@map("users")
}

model Area {
  id            String   @id @default(cuid())
  name          AreaName @unique
  code          String   @unique
  ticketCounter Int      @default(0)

  // Relacionamentos
  users    User[]
  tickets  Ticket[]
  comments Comment[]

  @@map("areas")
}

model Attachment {
  id        String   @id @default(cuid())
  filename  String // Nome original do arquivo (ex: "screenshot.png")
  url       String // URL do Vercel Blob
  fileType  String? // ex: "image/png"
  size      Int? // Tamanho em bytes
  createdAt DateTime @default(now())

  // Relacionamento com o Chamado
  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  // Relacionamento com quem fez o upload
  uploaderId String
  uploader   User   @relation(fields: [uploaderId], references: [id])

  @@index([ticketId])
  @@index([uploaderId])
  @@map("attachments")
}

model Ticket {
  id       String @id @default(cuid())
  ticketId String @unique
  title    String
  status   Status @default(OPEN)

  // Detalhes do chamado (obrigatórios)
  description String
  location    String // Ex: "Sala 301, Bloco B"
  equipment   String // Ex: "Ar Condicionado"
  model       String // Ex: "Samsung Wind-Free"
  assetTag    String // Ex: "N/P 123456"

  priority  Priority @default(LOW)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  satisfactionRating Int? // Armazena a nota (1-5). É opcional.
  resolvedAt         DateTime? // Armazena a data/hora da primeira resolução
  slaDeadline        DateTime? // Prazo de SLA

  // Chaves Estrangeiras e Relacionamentos
  areaId String
  area   Area   @relation(fields: [areaId], references: [id])

  requesterId String
  requester   User   @relation("TicketRequester", fields: [requesterId], references: [id])

  technicianId String?
  technician   User?   @relation("TicketTechnician", fields: [technicianId], references: [id])

  comments    Comment[]
  attachments Attachment[]

  @@index([areaId])
  @@index([ticketId])
  @@index([requesterId])
  @@index([technicianId])
  @@map("tickets")
}

model Comment {
  id         String   @id @default(cuid())
  text       String
  createdAt  DateTime @default(now())
  isInternal Boolean  @default(false) // Comentário interno (Técnico <-> Gestor)

  // Relacionamentos
  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  areaId String
  area   Area   @relation(fields: [areaId], references: [id])

  @@index([ticketId])
  @@index([userId])
  @@index([areaId])
  @@map("comments")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
  @@map("password_reset_tokens")
}

model PushSubscription {
  id        String   @id @default(cuid())
  endpoint  String   @unique // O endereço único do browser
  p256dh    String   // Chave de criptografia
  auth      String   // Chave de autenticação
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@map("push_subscriptions")
  @@index([userId])
}